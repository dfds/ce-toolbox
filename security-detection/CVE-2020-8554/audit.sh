#!/bin/bash

set -eo pipefail

# Define the SAML role to use and login with that role
SAML_ROLE="arn:aws:iam::738063116313:role/CloudEngineer"
saml2aws login --role=$SAML_ROLE --force

# Get services with externalIP other than none
SVC=$(kubectl get svc -A | grep -v '<none>')
COUNT_VULNARBLE_SVC=$(echo "$SVC" | wc -l)

echo ""
echo "=================================="
echo ""

if [[ $COUNT_VULNARBLE_SVC > 1 ]]
then
    echo "Services with spec.externalIP detected:"
    echo "$SVC"
    exit 1
else
    echo "No services with spec.externalIP detected, all good!"
    exit 0
fi