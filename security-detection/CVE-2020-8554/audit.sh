#!/bin/bash

set -eo pipefail

# Fill in these values before running the script
AWS_ACCOUNT="" # K8s Cluster account
SAML_ROLE="" # Cloud Engineer role
go-aws-sso assume --account-id $AWS_ACCOUNT --role-name $SAML_ROLE

# Get services with externalIP other than none
SVC=$(kubectl get svc -A | grep -v '<none>')
COUNT_VULNARBLE_SVC=$(echo "$SVC" | wc -l)

echo ""
echo "=================================="
echo ""

if [[ $COUNT_VULNARBLE_SVC > 1 ]]
then
    echo "Services with spec.externalIP detected:"
    echo "$SVC"
    exit 1
else
    echo "No services with spec.externalIP detected, all good!"
    exit 0
fi